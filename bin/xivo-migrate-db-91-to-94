#!/bin/sh

MIGRATION_LOG_FILE="/var/log/xivo-database-migration-91-to-94.log"

cluster_exists() {
	# similar check as in the postgresql-client-common package
	local version="$1"
	local name="$2"

	echo "cluster_exists()"
	ls "/etc/postgresql/$version/$name/postgresql.conf"
	[ -f "/etc/postgresql/$version/$name/postgresql.conf" ]
}

stop_services() {
	echo "Stopping services..."
	service cron stop
	echo "Killing xivo-stat..."
	pgrep -lf xivo-stat
	echo "xivo-stat killed"
	echo "Killing xivo-call-logs..."
	pgrep -lf xivo-call-logs
	echo "xivo-call-logs killed"
	sleep 600
}

migrate_db() {
	echo "Upgrading database cluster..."

	echo "Check if cluster_exists 9.4"
	if cluster_exists 9.4 main; then
		echo "Removing 9.4 cluster..."
		pg_dropcluster --stop 9.4 main
	    echo "9.4 cluster removed"
	fi

	echo "Upgrading 9.1 cluster to 9.4..."
	if ! pg_upgradecluster --link -m upgrade -v 9.4 9.1 main >>$MIGRATION_LOG_FILE; then
	    echo "pg_upgradecluster failed, return 1"
		return 1
	fi

	echo "Removing old 9.1 cluster..."
	pg_dropcluster --stop 9.1 main
	echo "old 9.1 cluster removed"
}

start_services() {
	echo "Starting services..."
	service cron start
}

echo "Upgrading PostgreSQL cluster from 9.1 to 9.4..."

stop_services
migrate_db
result=$?
start_services

if [ "$result" -eq 0 ]; then
	echo "PostgreSQL cluster upgrade from 9.1 to 9.4 successful"
else
	echo "ERROR: upgrade failed, see $MIGRATION_LOG_FILE for more info."
fi

exit "$result"
